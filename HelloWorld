public static async Task<JsonDocument> RemoveKeysAsync(JsonDocument inputJson, List<string> keysToRemove)
{
    using (var stream = new MemoryStream())
    using (var writer = new Utf8JsonWriter(stream))
    {
        if (inputJson.RootElement.ValueKind == JsonValueKind.Object)
        {
            writer.WriteStartObject();
            foreach (var property in inputJson.RootElement.EnumerateObject())
            {
                if (!keysToRemove.Contains(property.Name))
                {
                    property.WriteTo(writer);
                }
            }
            writer.WriteEndObject();
        }
        else if (inputJson.RootElement.ValueKind == JsonValueKind.Array)
        {
            writer.WriteStartArray();
            foreach (var element in inputJson.RootElement.EnumerateArray())
            {
                if (element.ValueKind == JsonValueKind.Object)
                {
                    writer.WriteStartObject();
                    foreach (var property in element.EnumerateObject())
                    {
                        if (!keysToRemove.Contains(property.Name))
                        {
                            property.WriteTo(writer);
                        }
                    }
                    writer.WriteEndObject();
                }
                else
                {
                    element.WriteTo(writer);
                }
            }
            writer.WriteEndArray();
        }
        await writer.FlushAsync();
        stream.Position = 0;
        return await JsonDocument.ParseAsync(stream);
    }
}


public static async Task<JsonDocument> FilterJsonByValuesAsync(JsonDocument inputJson, string key, List<string> valuesToKeep)
{
    using (var stream = new MemoryStream())
    using (var writer = new Utf8JsonWriter(stream))
    {
        if (inputJson.RootElement.ValueKind == JsonValueKind.Object)
        {
            writer.WriteStartObject();
            if (inputJson.RootElement.TryGetProperty(key, out JsonElement element) && valuesToKeep.Contains(element.GetString()))
            {
                foreach (var property in inputJson.RootElement.EnumerateObject())
                {
                    property.WriteTo(writer);
                }
            }
            writer.WriteEndObject();
        }
        else if (inputJson.RootElement.ValueKind == JsonValueKind.Array)
        {
            writer.WriteStartArray();
            foreach (var arrayElement in inputJson.RootElement.EnumerateArray())
            {
                if (arrayElement.ValueKind == JsonValueKind.Object)
                {
                    if (arrayElement.TryGetProperty(key, out JsonElement element) && valuesToKeep.Contains(element.GetString()))
                    {
                        writer.WriteStartObject();
                        foreach (var property in arrayElement.EnumerateObject())
                        {
                            property.WriteTo(writer);
                        }
                        writer.WriteEndObject();
                    }
                }
                else
                {
                    arrayElement.WriteTo(writer);
                }
            }
            writer.WriteEndArray();
        }
        await writer.FlushAsync();
        stream.Position = 0;
        return await JsonDocument.ParseAsync(stream);
    }
}


public static async Task<JsonDocument> MultiplyKeyByValueAsync(JsonDocument inputJson, string key, double multiplier)
{
    using (var stream = new MemoryStream())
    using (var writer = new Utf8JsonWriter(stream))
    {
        if (inputJson.RootElement.ValueKind == JsonValueKind.Object)
        {
            writer.WriteStartObject();
            foreach (var property in inputJson.RootElement.EnumerateObject())
            {
                if (property.Name == key && property.Value.ValueKind == JsonValueKind.Number)
                {
                    writer.WritePropertyName(property.Name);
                    writer.WriteNumberValue(property.Value.GetDouble() * multiplier);
                }
                else
                {
                    property.WriteTo(writer);
                }
            }
            writer.WriteEndObject();
        }
        else if (inputJson.RootElement.ValueKind == JsonValueKind.Array)
        {
            writer.WriteStartArray();
            foreach (var element in inputJson.RootElement.EnumerateArray())
            {
                if (element.ValueKind == JsonValueKind.Object)
                {
                    writer.WriteStartObject();
                    foreach (var property in element.EnumerateObject())
                    {
                        if (property.Name == key && property.Value.ValueKind == JsonValueKind.Number)
                        {
                            writer.WritePropertyName(property.Name);
                            writer.WriteNumberValue(property.Value.GetDouble() * multiplier);
                        }
                        else
                        {
                            property.WriteTo(writer);
                        }
                    }
                    writer.WriteEndObject();
                }
                else
                {
                    element.WriteTo(writer);
                }
            }
            writer.WriteEndArray();
        }
        await writer.FlushAsync();
        stream.Position = 0;
        return await JsonDocument.ParseAsync(stream);
    }
}
